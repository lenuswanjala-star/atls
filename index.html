<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google OAuth 2.0 Demo</title>
</head>
<body>
  <h1>Google OAuth 2.0 Demo</h1>
  <button onclick="trySampleRequest();">Sign in with Google</button>

  <h2>Drive Info:</h2>
  <pre id="drive-info">Not signed in yet.</pre>

  <h2>Calendar List:</h2>
  <pre id="calendar-info">Not signed in yet.</pre>

  <script>
    // Your OAuth credentials
    var YOUR_CLIENT_ID = '788099682177-40c5sl6rrmtqcuiq2feqdnldgqedvp3i.apps.googleusercontent.com';
    var YOUR_REDIRECT_URI = 'https://lenuswanjala-star.github.io/oauth2callback';

    // Parse access token from URL fragment
    var fragmentString = location.hash.substring(1);
    var params = {};
    var regex = /([^&=]+)=([^&]*)/g, m;
    while (m = regex.exec(fragmentString)) {
      params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
    }

    if (Object.keys(params).length > 0 && params['state']) {
      if (params['state'] === localStorage.getItem('state')) {
        localStorage.setItem('oauth2-test-params', JSON.stringify(params));
        trySampleRequest();
      } else {
        console.log('State mismatch. Possible CSRF attack.');
      }
    }

    // Generate random state to prevent CSRF
    function generateCryptoRandomState() {
      const randomValues = new Uint32Array(2);
      window.crypto.getRandomValues(randomValues);
      return btoa(String.fromCharCode.apply(null, randomValues))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Main function to check token or start OAuth
    function trySampleRequest() {
      var params = JSON.parse(localStorage.getItem('oauth2-test-params'));
      if (params && params['access_token']) {
        console.log('Access token obtained:', params['access_token']);
        fetchDriveInfo(params['access_token']);
        fetchCalendarList(params['access_token']);
      } else {
        oauth2SignIn();
      }
    }

    // OAuth 2.0 sign-in
    function oauth2SignIn() {
      var state = generateCryptoRandomState();
      localStorage.setItem('state', state);

      var oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';
      var form = document.createElement('form');
      form.setAttribute('method', 'GET');
      form.setAttribute('action', oauth2Endpoint);

      var params = {
        'client_id': YOUR_CLIENT_ID,
        'redirect_uri': YOUR_REDIRECT_URI,
        'scope': 'https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/calendar.readonly',
        'state': state,
        'include_granted_scopes': 'true',
        'response_type': 'token'
      };

      for (var p in params) {
        var input = document.createElement('input');
        input.setAttribute('type', 'hidden');
        input.setAttribute('name', p);
        input.setAttribute('value', params[p]);
        form.appendChild(input);
      }

      document.body.appendChild(form);
      form.submit();
    }

    // Fetch Google Drive info
    function fetchDriveInfo(token) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/drive/v3/about?fields=user,storageQuota&access_token=' + token);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          document.getElementById('drive-info').textContent = xhr.responseText;
        } else if (xhr.readyState === 4) {
          document.getElementById('drive-info').textContent = 'Failed to fetch Drive info.';
        }
      };
      xhr.send();
    }

    // Fetch Google Calendar list
    function fetchCalendarList(token) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/calendar/v3/users/me/calendarList?access_token=' + token);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          document.getElementById('calendar-info').textContent = xhr.responseText;
        } else if (xhr.readyState === 4) {
          document.getElementById('calendar-info').textContent = 'Failed to fetch Calendar list.';
        }
      };
      xhr.send();
    }
  </script>
</body>
</html>



