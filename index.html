<!DOCTYPE html>
<html>
<head>
  <title>Deleted Gmail Viewer</title>
</head>
<body>
  <h2>View Deleted Conversation</h2>
  <button onclick="handleAuthClick()">Sign in & Show Deleted Emails</button>
  <pre id="output">Not signed in yet.</pre>

  <script>
    const CLIENT_ID = "788099682177-40c5sl6rrmtqcuiq2feqdnldgqedvp3i.apps.googleusercontent.com";
    const API_KEY = "AIzaSyCeH-qWjz6dlIsa_WKFcVzJ-WAmOPF-AF8";
    const SCOPES = "https://www.googleapis.com/auth/gmail.readonly";

    let tokenClient;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"],
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: listTrashMessages,
      });
    }

    function handleAuthClick() {
      tokenClient.requestAccessToken();
    }

    async function listTrashMessages() {
      try {
        const response = await gapi.client.gmail.users.messages.list({
          userId: "me",
          q: "in:trash from:isiham.mahibu@mpesafoundationacademy.ac.ke"
        });

        const messages = response.result.messages;
        if (!messages || messages.length === 0) {
          document.getElementById("output").innerText = "No deleted messages found.";
          return;
        }

        // Fetch each message detail
        let results = "";
        for (let msg of messages) {
          const detail = await gapi.client.gmail.users.messages.get({
            userId: "me",
            id: msg.id
          });
          results += detail.result.snippet + "\n\n";
        }
        document.getElementById("output").innerText = results;

      } catch (err) {
        document.getElementById("output").innerText = "Error: " + err.message;
      }
    }
  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>

