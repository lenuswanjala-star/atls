<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gmail Deleted Messages Viewer</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .message { border: 1px solid #ccc; padding: 10px; margin: 5px 0; cursor: pointer; border-radius: 6px; }
    .message:hover { background: #f0f0f0; }
    .body { margin-top: 10px; padding: 10px; background: #fafafa; border-left: 3px solid #007bff; display: none; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Gmail Deleted Messages Viewer</h2>
  <button id="authorize-button">Authorize Gmail</button>
  <button id="signout-button" style="display:none">Sign Out</button>
  <div id="messages"></div>

  <script>
    const CLIENT_ID = "788099682177-40c5sl6rrmtqcuiq2feqdnldgqedvp3i.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/gmail.readonly";

    let tokenClient;

    document.getElementById("authorize-button").onclick = handleAuthClick;
    document.getElementById("signout-button").onclick = handleSignoutClick;

    function gapiLoaded() {
      gapi.load("client", initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"],
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: "",
      });
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw resp;
        document.getElementById("signout-button").style.display = "block";
        document.getElementById("authorize-button").innerText = "Refresh";
        await listMessages("in:trash");
      };
      if (!gapi.client.getToken()) {
        tokenClient.requestAccessToken({ prompt: "consent" });
      } else {
        tokenClient.requestAccessToken({ prompt: "" });
      }
    }

    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken("");
        document.getElementById("messages").innerHTML = "";
        document.getElementById("signout-button").style.display = "none";
      }
    }

    async function listMessages(query) {
      let response = await gapi.client.gmail.users.messages.list({
        userId: "me",
        q: query,
        maxResults: 10,
      });
      let messages = response.result.messages;
      if (!messages) {
        document.getElementById("messages").innerText = "No deleted messages found.";
        return;
      }

      document.getElementById("messages").innerHTML = "";

      for (let m of messages) {
        let msg = await gapi.client.gmail.users.messages.get({
          userId: "me",
          id: m.id,
          format: "metadata",
          metadataHeaders: ["From", "Subject", "Date"]
        });

        let headers = msg.result.payload.headers;
        let from = headers.find(h => h.name === "From")?.value || "Unknown";
        let subject = headers.find(h => h.name === "Subject")?.value || "No Subject";
        let date = headers.find(h => h.name === "Date")?.value || "No Date";

        let div = document.createElement("div");
        div.className = "message";
        div.innerHTML = `<strong>${subject}</strong><br>From: ${from}<br><small>${date}</small>`;

        let bodyDiv = document.createElement("div");
        bodyDiv.className = "body";
        bodyDiv.id = `body-${m.id}`;
        div.appendChild(bodyDiv);

        div.onclick = async () => {
          if (bodyDiv.style.display === "block") {
            bodyDiv.style.display = "none";
            return;
          }
          let fullMsg = await gapi.client.gmail.users.messages.get({
            userId: "me",
            id: m.id,
            format: "full"
          });

          let bodyData = getBody(fullMsg.result.payload);
          let decodedBody = bodyData ? atob(bodyData.replace(/-/g, '+').replace(/_/g, '/')) : "(No Content)";
          bodyDiv.innerText = decodedBody;
          bodyDiv.style.display = "block";
        };

        document.getElementById("messages").appendChild(div);
      }
    }

    function getBody(payload) {
      let body = "";
      if (payload.parts) {
        for (let part of payload.parts) {
          if (part.mimeType === "text/plain" && part.body.data) {
            return part.body.data;
          }
        }
      } else if (payload.body && payload.body.data) {
        return payload.body.data;
      }
      return body;
    }
  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>


