<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deleted Gmail Messages Viewer</title>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  button { margin: 5px; padding: 10px; }
  .email { border-bottom: 1px solid #ccc; padding: 10px 0; }
  .subject { font-weight: bold; }
  .from { color: #555; }
  .snippet { margin-top: 5px; }
</style>
</head>
<body>
<h1>Deleted Gmail Messages Viewer</h1>
<button id="authorize_button">Sign in with Google</button>
<button id="signout_button" style="display:none;">Sign Out</button>
<div id="content"></div>

<script>
const CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // Replace with your OAuth Client ID
const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

let tokenClient;
let gapiInited = false;
let gisInited = false;

// Load GAPI client
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
    });
    gapiInited = true;
    maybeEnableButtons();
}

// Initialize Google Identity Services
function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', 
    });
    gisInited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('authorize_button').style.display = 'block';
    }
}

// Sign in
document.getElementById('authorize_button').onclick = () => {
    tokenClient.callback = async (resp) => {
        if (resp.error) throw(resp);
        document.getElementById('authorize_button').style.display = 'none';
        document.getElementById('signout_button').style.display = 'block';
        await listDeletedMessages();
    };
    tokenClient.requestAccessToken();
};

// Sign out
document.getElementById('signout_button').onclick = () => {
    google.accounts.oauth2.revoke(tokenClient.access_token);
    document.getElementById('content').innerHTML = '';
    document.getElementById('authorize_button').style.display = 'block';
    document.getElementById('signout_button').style.display = 'none';
};

// Fetch deleted emails from Trash
async function listDeletedMessages() {
    const response = await gapi.client.gmail.users.messages.list({
        userId: 'me',
        labelIds: ['TRASH'],
        maxResults: 10
    });

    const messages = response.result.messages || [];
    const contentDiv = document.getElementById('content');
    contentDiv.innerHTML = '<h2>Deleted Messages:</h2>';

    if (messages.length === 0) {
        contentDiv.innerHTML += 'No deleted messages found.';
        return;
    }

    for (let msg of messages) {
        const msgDetail = await gapi.client.gmail.users.messages.get({
            userId: 'me',
            id: msg.id,
            format: 'full'
        });

        const headers = msgDetail.result.payload.headers;
        const subject = headers.find(h => h.name === 'Subject')?.value || '(No Subject)';
        const from = headers.find(h => h.name === 'From')?.value || '(Unknown Sender)';
        let body = '';

        if (msgDetail.result.payload.parts) {
            // Get the plain text part
            const part = msgDetail.result.payload.parts.find(p => p.mimeType === 'text/plain');
            if (part && part.body.data) {
                body = atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/'));
            }
        } else if (msgDetail.result.payload.body.data) {
            body = atob(msgDetail.result.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
        }

        contentDiv.innerHTML += `
            <div class="email">
                <div class="subject">Subject: ${subject}</div>
                <div class="from">From: ${from}</div>
                <div class="snippet">${body || '(No content)'}</div>
            </div>
        `;
    }
}
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
