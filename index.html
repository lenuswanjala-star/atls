<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Deleted Emails from Eugene</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Deleted Emails from Eugene</h1>
  <button id="authorize_button">Sign in with Google</button>
  <div id="emails"></div>

  <script>
    const CLIENT_ID = '788099682177-40c5sl6rrmtqcuiq2feqdnldgqedvp3i.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCeH-qWjz6dlIsa_WKFcVzJ-WAmOPF-AF8';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

    const authorizeButton = document.getElementById('authorize_button');
    const emailsDiv = document.getElementById('emails');

    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(() => {
        authorizeButton.onclick = handleAuthClick;
      });
    }

    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn().then(listDeletedFromEugene);
    }

    function listDeletedFromEugene() {
      gapi.client.gmail.users.messages.list({
        userId: 'me',
        labelIds: ['TRASH'], // search only deleted messages
        q: 'from:eugene.omboga@mpesafoundationacademy.ac.ke'
      }).then(response => {
        const messages = response.result.messages || [];
        if (messages.length === 0) {
          emailsDiv.innerHTML = '<p>No deleted emails found from Eugene.</p>';
          return;
        }

        emailsDiv.innerHTML = '';
        messages.forEach(msg => {
          gapi.client.gmail.users.messages.get({
            userId: 'me',
            id: msg.id
          }).then(msgResponse => {
            const payload = msgResponse.result.payload;
            let body = '';

            if (payload.parts) {
              payload.parts.forEach(p => {
                if (p.body && p.body.data) {
                  body += atob(p.body.data.replace(/-/g, '+').replace(/_/g, '/'));
                }
              });
            } else if (payload.body && payload.body.data) {
              body = atob(payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
            }

            const emailElement = document.createElement('div');
            emailElement.innerHTML = `<hr><strong>Subject:</strong> ${
              (payload.headers.find(h => h.name === "Subject") || {}).value || "(No Subject)"
            }<br><pre>${body}</pre>`;
            emailsDiv.appendChild(emailElement);
          });
        });
      });
    }

    gapi.load('client:auth2', initClient);
  </script>
</body>
</html>



